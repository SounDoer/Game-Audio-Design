<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Topic/A-Practice-of-Music-as-Level-Design-with-UE-Wwise" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">“音乐作为关卡设计” UE &amp; Wwise 实践案例 | Game Audio Design</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://soundoer.com/Game-Audio-Design/zh-Hans/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://soundoer.com/Game-Audio-Design/zh-Hans/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://soundoer.com/Game-Audio-Design/zh-Hans/Topic/A-Practice-of-Music-as-Level-Design-with-UE-Wwise"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="“音乐作为关卡设计” UE &amp; Wwise 实践案例 | Game Audio Design"><meta data-rh="true" name="description" content="*"><meta data-rh="true" property="og:description" content="*"><link data-rh="true" rel="icon" href="/Game-Audio-Design/zh-Hans/img/GAD_Logo.ico"><link data-rh="true" rel="canonical" href="https://soundoer.com/Game-Audio-Design/zh-Hans/Topic/A-Practice-of-Music-as-Level-Design-with-UE-Wwise"><link data-rh="true" rel="alternate" href="https://soundoer.com/Game-Audio-Design/Topic/A-Practice-of-Music-as-Level-Design-with-UE-Wwise" hreflang="en"><link data-rh="true" rel="alternate" href="https://soundoer.com/Game-Audio-Design/zh-Hans/Topic/A-Practice-of-Music-as-Level-Design-with-UE-Wwise" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://soundoer.com/Game-Audio-Design/Topic/A-Practice-of-Music-as-Level-Design-with-UE-Wwise" hreflang="x-default"><link rel="stylesheet" href="/Game-Audio-Design/zh-Hans/assets/css/styles.4a3518ac.css">
<script src="/Game-Audio-Design/zh-Hans/assets/js/runtime~main.93d03520.js" defer="defer"></script>
<script src="/Game-Audio-Design/zh-Hans/assets/js/main.eb1c8026.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/Game-Audio-Design/zh-Hans/img/GAD_Logo_Black.png"><link rel="preload" as="image" href="/Game-Audio-Design/zh-Hans/img/GAD_Logo_White.png"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Game-Audio-Design/zh-Hans/"><div class="navbar__logo"><img src="/Game-Audio-Design/zh-Hans/img/GAD_Logo_Black.png" alt="GAD Horse Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/Game-Audio-Design/zh-Hans/img/GAD_Logo_White.png" alt="GAD Horse Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/Game-Audio-Design/zh-Hans/">Course</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Game-Audio-Design/zh-Hans/Topic/intro">Topic</a><a class="navbar__item navbar__link" href="/Game-Audio-Design/zh-Hans/Resource">Resource</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/Game-Audio-Design/zh-Hans/Log">  </a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/intro">Xichen&#x27;s Game Audio Design Document</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/A-Practice-of-Audio-Visualization-with-UE-Wwise">“音频可视化” UE &amp; Wwise 实践案例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/Game-Audio-Design/zh-Hans/Topic/A-Practice-of-Music-as-Level-Design-with-UE-Wwise">“音乐作为关卡设计” UE &amp; Wwise 实践案例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/A-Procedural-Way-of-Melee-Weapon-Whoosh-Sound-Design">冷兵器 Procedural Whoosh 音频设计案例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/A-Project-Case-of-Object-Based-Audio-Design-and-Mixing">Object-Based Audio 音频设计与混音案例</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/A-Thought-of-Designing-Sound-in-Game-Deconstruction-and-Modeling">游戏音频设计的一种思路：解构与建模</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/Audio-Design-Pipeline-of-Realtime-Cinematic-in-Object-Based-Audio">基于对象音频的游戏实时动画音频设计流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/Game-Audio-Designer-Technical-Audio-Designer-and-Audio-Programmer">游戏音频设计师、技术音频设计师和音频程序员</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/How-to-Search-Audio-Design-Information">如何搜索有关音频设计的资讯</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/Incomprehensive-Game-Audio-Design-Skillset">非全面的游戏音频设计技能树</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/Listener-Centered-Dynamic-Wind-Audio-Design">基于听者的动态风声设计</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/Microsoft-Project-Acoustics-Wave-Physics-Simulation-Playtest">Microsoft Project Acoustics 声波物理模拟测试</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/Preface">前言</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/The-Workflow-of-Game-Audio-Design">游戏音频设计的工作流</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Game-Audio-Design/zh-Hans/Topic/What-will-The-Next-Gen-of-Game-Audio-Design-be-like">展望游戏音频设计的发展方向</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/Game-Audio-Design/zh-Hans/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">“音乐作为关卡设计” UE &amp; Wwise 实践案例</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>“音乐作为关卡设计” UE &amp; Wwise 实践案例</h1></header>
<hr>
<ul>
<li><a href="#%E6%98%8E%E7%A1%AE%E8%AE%BE%E8%AE%A1%E9%9C%80%E6%B1%82">明确设计需求</a></li>
<li><a href="#%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8-wwise-trigger-%E5%8A%9F%E8%83%BD">尝试使用 Wwise Trigger 功能</a></li>
<li><a href="#%E9%82%A3%E5%B0%B1%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%E5%86%99%E5%90%A7">那就自己动手写吧</a>
<ul>
<li><a href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E6%92%AD%E6%94%BE%E4%BD%8D%E7%BD%AE%E4%BF%A1%E6%81%AF">获取当前播放位置信息</a></li>
<li><a href="#%E8%8E%B7%E5%8F%96%E8%8A%82%E6%8B%8D%E7%82%B9%E4%BD%8D%E7%BD%AE%E4%BF%A1%E6%81%AF">获取节拍点位置信息</a></li>
<li><a href="#%E8%AE%A1%E7%AE%97%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%97%B6%E9%97%B4%E7%82%B9">计算函数调用时间点</a></li>
</ul>
</li>
<li><a href="#%E6%9C%80%E7%BB%88%E5%AE%9E%E7%8E%B0">最终实现</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
<hr>
<p>2021年1月 Global Game Jam，我与叶梓涛做了一款着重声音体验的禅意动作游戏<a href="https://yezi.itch.io/sz" target="_blank" rel="noopener noreferrer">《剑入禅境 Sword Zen》</a>。受限于 GameJam 开发时间，当时的设计想法并没有能够彻底实现；不少玩家朋友们试玩之后发来了反馈，也让我们有了新的灵感。因此正好把这个项目作为个人的游戏开发练习，我从核心声音体验和玩法扩展性的角度入手开始重新编写代码。<br>
<!-- -->在完成了原有玩法的重构之后，将要进行的一个最大的设计改动就是要让玩家的操作与游戏中的音乐产生更强的关联。音乐不再只是游戏进度的提示和主观情绪的表达，而是要能提供更类似于音乐节奏游戏中“音乐作为关卡设计”的功能。比如，通过音乐中的节拍点来控制敌人的攻击行为，这样的话玩家作出相应反馈时的格挡成功与失败的时间点都会统一在音乐整体的节奏中，给玩家一种类似音游的打击爽快感；同时，这也为之后互动音乐的设计提供了更多可能性，根据玩家单次或多次的格挡结果来顺畅地衔接不同的音乐片段，引导玩家情绪和切换游戏阶段。<br>
<!-- -->接下来我将使用游戏引擎 Unreal Engine 和音频中间件 Wwise 工具，以“音乐节拍信息控制敌人攻击行为”为例，来详细分析一下设计思路和代码实现的具体过程。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">开发环境与工具：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unreal Engine 4.26 C++ &amp; Blueprint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Audiokinetic Wwise 2019.2.9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="明确设计需求">明确设计需求<a href="#明确设计需求" class="hash-link" aria-label="明确设计需求的直接链接" title="明确设计需求的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="HandleAttack Function Explanation" src="/Game-Audio-Design/zh-Hans/assets/images/HandleAttack-e7923baff6cfb28a114233b114855084.jpeg" width="1920" height="1080" class="img_ev3q"></p>
<p>首先需要明确具体的设计需求。如上图所示，敌人的攻击行为由带有一个参数的 HandleAttack(WeaponType) 函数控制，WeaponType 决定了所用武器的各类属性，其中与此处设计相关的数值是 Charge Time，即不同武器有着不同的充能时间。HandleAttack 函数执行时首先获取当前的 WeaponType，然后进行 Start Charge，在经过 Charge Time 之后才实施 Actual Attack。需要实现的设计需求是，敌人在使用不同武器时（即 Charge Time 可变的情况下），Actual Attack 实施的时间点都将与音乐中的节拍点保持一致。<br>
<!-- -->其实在 Wwise 中通过音乐内的标记信息来触发函数的功能实现并不复杂，原生 API 中的 PostEvent() 函数本身就开放了回调函数（Callback Function）。<strong>只不过，这个案例的设计需求稍微有些不同的地方是，音乐中需要标记的时间点确实是在节拍点上，但实际调用函数的时间点却是在标记的节拍点之前，且调用函数的提前时间量是由游戏中的参数来实时决定的，因此每次实施攻击时都需要进行额外的计算。</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="尝试使用-wwise-trigger-功能">尝试使用 Wwise Trigger 功能<a href="#尝试使用-wwise-trigger-功能" class="hash-link" aria-label="尝试使用 Wwise Trigger 功能的直接链接" title="尝试使用 Wwise Trigger 功能的直接链接">​</a></h2>
<p>如上一节所说，Wwise 本身已有根据音乐标记信息触发回调函数的功能，对于需要提前触发且对齐节拍点的设计需求，我首先想到的是利用 Wwise 提供的 Trigger 功能。</p>
<p><img decoding="async" loading="lazy" alt="Wwise Trigger Solution" src="/Game-Audio-Design/zh-Hans/assets/images/WwiseTriggerSolution-23ba3ed5524eec6f2046a44420fc7391.jpeg" width="1920" height="1080" class="img_ev3q"></p>
<p>如上图所示，使用 Trigger 功能进行实现的设计思路是：在 Stinger 声音片段（此处可以理解为是开始攻击时的武器 Whoosh 音效）中，调整 Sync Point 用于对齐 Music Track 中节拍点的 Custom Cue 标记信息，并在 Stinger 片段开头添加用于真正触发回调函数的 Custom Cue 标记信息。游戏运行过程中在任意时刻触发 Trigger，受 Trigger 控制的 Stinger 片段都将响应 Music Track 中下一个标记信息点，只要 Stinger 片段开头的标记信息能够被触发，那就验证此方案可行。</p>
<p><img decoding="async" loading="lazy" alt="Wwise Trigger Solution Test" src="/Game-Audio-Design/zh-Hans/assets/images/WwiseTriggerSolution_Test-2a94644eeeea98a6894895a907d4eadd.png" width="2752" height="1091" class="img_ev3q"></p>
<p>但是！在 UE 中使用 Blueprint 进行快速验证后发现，通过 PostEvent 的方式触发 Trigger，由 Trigger 控制的 Stinger 中包含的 Custom Cue 信息无法被获取；进一步研究 Wwise SDK 后发现，通过 PostTrigger 的方式直接触发 Trigger 也不可行，此函数并没有开放任何与回调函数相关的接口。</p>
<p><img decoding="async" loading="lazy" alt="Wwise SDK PostTrigger" src="/Game-Audio-Design/zh-Hans/assets/images/AkSoundEngine_PostTrigger-aa3522800df22156b6893b02d88d4142.png" width="1044" height="616" class="img_ev3q"></p>
<p>至此，尝试使用 Wwise Trigger 功能来实现“嵌套式”的 Custom Cue 触发回调函数的方式验证不可行。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="那就自己动手写吧">那就自己动手写吧<a href="#那就自己动手写吧" class="hash-link" aria-label="那就自己动手写吧的直接链接" title="那就自己动手写吧的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="Position On Track" src="/Game-Audio-Design/zh-Hans/assets/images/PositionOnTrack-a06253709e2212a9cb6ab9ac61bbfee8.jpeg" width="1741" height="550" class="img_ev3q"></p>
<p>既然上述方案无法实现，那就只能跳出现有思路框架，自己动手实现了，需要解决的核心问题就是如何实时地计算出调用 HandleAttack() 函数的时间点。而所谓的时间点对应到 Music Track 上其实就是播放位置（Play Position），因此函数调用时机的判断条件转化为算术表达式就是：</p>
<ul>
<li>节拍点位置（Cue Position）- 当前播放位置（Current Position）&lt; 武器充能时间长度（Charge Time Length）</li>
</ul>
<p>另外，考虑到音乐循环播放的情况，为了确保当前播放位置永远是与当前播放片段中的下一个节拍点进行比较，还有一个判断条件需要满足：</p>
<ul>
<li>节拍点位置（Cue Position）&gt; 当前播放位置（Current Position）</li>
</ul>
<p>所以，只要设法获取到节拍点位置和当前播放位置的信息就能计算出调用函数的时间点。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="获取当前播放位置信息">获取当前播放位置信息<a href="#获取当前播放位置信息" class="hash-link" aria-label="获取当前播放位置信息的直接链接" title="获取当前播放位置信息的直接链接">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Wwise SDK GetSourcePlayPosition" src="/Game-Audio-Design/zh-Hans/assets/images/AkSoundEngine_GetSourcePlayPosition-dc2722e2252ba82c2603f30d9ad3f0fe.png" width="1587" height="523" class="img_ev3q"></p>
<p>配合使用 AkCallbackType 标志 <code>AK_EnableGetSourcePlayPosition</code>，<code>AK::SoundEngine::PostEvent</code> 返回当前播放声音片段的 <code>AkPlayingID</code>，将此 ID 传入 <code>AK::SoundEngine::GetSourcePlayPosition</code> 即可获得当前的播放位置。</p>
<p>注：有需要的话可以使用 <code>AK::MusicEngine::GetPlayingSegmentInfo</code>，从返回的 <code>AkSegmentInfo</code> 中获取更多信息。</p>
<p>首先在 AkGameplayStatics 类中创建一个封装 <code>AK::SoundEngine::GetSourcePlayPosition</code> 的函数，便于之后在 C++ 或 Blueprint 中调用。</p>
<p><code>AkGameplayStatics.h</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	UFUNCTION(BlueprintCallable, BlueprintCosmetic, Category = &quot;SZ | Wwise&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	static int32 GetSourcePlayPosition(int32 PlayingID);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>AkGameplayStatics.cpp</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int32 UAkGameplayStatics::GetSourcePlayPosition(int32 PlayingID)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	AkTimeMs CurrentPosition = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	auto Result = AK::SoundEngine::GetSourcePlayPosition(PlayingID, &amp;CurrentPosition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if (Result == AK_Success)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return CurrentPosition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		GEngine-&gt;AddOnScreenDebugMessage(-1, 2.f, FColor::Red, TEXT(&quot;GetSourcePlayPosition FAILED!&quot;), false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>需要注意的是，Blueprint 中的 PostEvent 节点默认隐藏了 <code>AK_EnableGetSourcePlayPosition</code> 标志，因此需要做一些额外的修改将其暴露出来。在 AkGameplayTypes 类中的 <code>enum class EAkCallbackType</code> 部分添加以下信息。</p>
<p><code>AkGameplayTypes.h</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EnableGetSourcePlayPosition = 20 UMETA(Tooltip = &quot;Enable play position info for AK::SoundEngine::GetSourcePlayPosition().&quot;),</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CHECK_CALLBACK_TYPE_VALUE(EnableGetSourcePlayPosition);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样一来就能在 PostEvent 节点中的 Callback Mask 下拉菜单里选择 Enable Get Source Play Position 选项了。</p>
<p><img decoding="async" loading="lazy" alt="PostEvent Callback Mask" src="/Game-Audio-Design/zh-Hans/assets/images/Blueprint_PostEventCallbackMask-0a69f07e884b5d5701ef92393501df76.png" width="481" height="681" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="获取节拍点位置信息">获取节拍点位置信息<a href="#获取节拍点位置信息" class="hash-link" aria-label="获取节拍点位置信息的直接链接" title="获取节拍点位置信息的直接链接">​</a></h3>
<p>首先在 DAW 中对音乐的节拍点进行标记，并将其导出成 .csv 文件。之后创建 <code>MusicCueStruct.h</code> 和相对应的 MusicCue Data Table，并将 .csv 文件信息导入其中。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#pragma once</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;CoreMinimal.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;Engine/DataTable.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;MusicCueStruct.generated.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USTRUCT(BlueprintType)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct FMusicCueStruct : public FTableRowBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	GENERATED_USTRUCT_BODY()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// Music cue position in segment (s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UPROPERTY(EditAnywhere, BlueprintReadOnly)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	float CuePosition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// Music cue name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UPROPERTY(EditAnywhere, BlueprintReadOnly)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FName CueName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="MusicCue Data Table" src="/Game-Audio-Design/zh-Hans/assets/images/MusicCueDataTable-e5c652dd34ee85dfbbd6c8e0228aff1d.png" width="285" height="344" class="img_ev3q"></p>
<p>考虑到仍然需要使用 Wwise State 来切换音乐片段，切换的同时需要加载对应片段的 MusicCue Data Table，因此需要创建 <code>MusicSegmentStruct.h</code> 和相对应的 MusicSegment Data Table，将 Wwise State 和 MusicCue Data Table 进行统一管理和调用。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#pragma once</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;CoreMinimal.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;Engine/DataTable.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;MusicSegmentStruct.generated.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USTRUCT(BlueprintType)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct FMusicSegmentStruct : public FTableRowBase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	GENERATED_USTRUCT_BODY()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// Music state group in Wwise</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UPROPERTY(EditAnywhere, BlueprintReadOnly)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FName MusicStateGroup;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// Music state in Wwise</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UPROPERTY(EditAnywhere, BlueprintReadOnly)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FName MusicState;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// The corresponding MusicCue Datatable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UPROPERTY(EditAnywhere, BlueprintReadOnly)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UDataTable* CueDataTable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="MusicSegment Data Table" src="/Game-Audio-Design/zh-Hans/assets/images/MusicSegmentDataTable-85052a4bceadf5b1657cb43ff6409e86.png" width="819" height="164" class="img_ev3q"></p>
<p>最后，创建 <code>SetMusicStateToGetSegmentInfo()</code> 函数用于在 Blueprint 中配合 GetDataTableRow 节点来调取上述数据。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	UFUNCTION(BlueprintCallable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	void SetMusicStateToGetSegmentInfo(const FName StateGroup, const FName State, class UDataTable* CueDataTable);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void AMainLevelManager::SetMusicStateToGetSegmentInfo(const FName StateGroup, const FName State, UDataTable* CueDataTable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// Set music state...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UAkStateValue* StateValue = nullptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UAkGameplayStatics::SetState(StateValue, StateGroup, State);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// Get corresponding cue data table...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	MusicCueDataTable = CueDataTable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// Get initial info...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	GetHandleEnemyAttackCueInfo();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中 <code>GetHandleEnemyAttackCueInfo()</code> 用于进一步处理 MusicCue Data Table，从中获取节拍点位置和武器充能时间长度的信息。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void AMainLevelManager::GetHandleEnemyAttackCueInfo()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if (MusicCueDataTable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		MusicCueRowNameArray = MusicCueDataTable-&gt;GetRowNames();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		FName MusicCueRowName = MusicCueRowNameArray[MusicCueRowNameArrayIndex];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		FMusicCueStruct* MusicCue = MusicCueDataTable-&gt;FindRow&lt;FMusicCueStruct&gt;(MusicCueRowName, TEXT(&quot;&quot;), true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (ensure(MusicCue))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			CuePosition = FMath::RoundToInt((*MusicCue).CuePosition * 1000); // Convert to (int32) ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			WeaponType = (*MusicCue).CueName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if (WeaponPropertyDataTable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		FWeaponPropertyStruct* WeaponProperty = WeaponPropertyDataTable-&gt;FindRow&lt;FWeaponPropertyStruct&gt;(WeaponType, TEXT(&quot;&quot;), true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (ensure(WeaponProperty))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			ChargeTimeLength = FMath::RoundToInt((*WeaponProperty).WeaponChargeTime * 1000); // Convert to (int32) ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="计算函数调用时间点">计算函数调用时间点<a href="#计算函数调用时间点" class="hash-link" aria-label="计算函数调用时间点的直接链接" title="计算函数调用时间点的直接链接">​</a></h3>
<p>获取了当前播放位置和节拍点位置的信息之后，就可以创建 <code>HandleEnemyAttackCueCallback()</code> 函数并依据上述两点判断条件来实时计算函数调用时间点了，且在每次判断为真且执行之后，获取下一个节拍点位置继续进行判断。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void AMainLevelManager::HandleEnemyAttackCueCallback(int32 AkPlayingID)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	int32 CurrentPosition = UAkGameplayStatics::GetSourcePlayPosition(AkPlayingID);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if (CuePosition - CurrentPosition &lt; ChargeTimeLength &amp;&amp; CuePosition &gt; CurrentPosition)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		bool bIsCallbackTriggered = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (bIsCallbackTriggered)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			OnEnemyAttackCue.Broadcast(WeaponType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			bIsCallbackTriggered = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			MusicCueRowNameArrayIndex += 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if (MusicCueRowNameArrayIndex &gt; MusicCueRowNameArray.Num() - 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				MusicCueRowNameArrayIndex = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			GetHandleEnemyAttackCueInfo();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中 <code>OnEnemyAttackCue.Broadcast(WeaponType)</code> 通过 Delegate 的方式将当前的 WeaponType 信息发送出去，敌人的 HandleAttack() 函数便会根据当前武器类型做出相应的攻击行为。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="最终实现">最终实现<a href="#最终实现" class="hash-link" aria-label="最终实现的直接链接" title="最终实现的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" alt="Final UE Blueprint Implementation" src="/Game-Audio-Design/zh-Hans/assets/images/BlueprintImplementation-4a8a6ba889d7f1af293478d7431a5ef7.png" width="1536" height="575" class="img_ev3q"></p>
<p>如上图，在 Blueprint 中简单使用几个节点即可实现最终的设计需求。</p>
<p>下图为整体的实现思路概览。</p>
<p><img decoding="async" loading="lazy" alt="Final Solution Overview" src="/Game-Audio-Design/zh-Hans/assets/images/SolutionOverview-e92b0507e6c7dc6bc018cdb0ccf82798.jpeg" width="3840" height="2074" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>最后，说回开头提到的“音乐作为关卡设计”的概念。这个案例只是简单地运用了节拍点这一元素，其实声音或音乐中还有很多丰富的元素，比如响度（Loudness）、频率（Frequency）、包络（Envelope）、音色（Timbre）、音调（Pitch）、旋律（Melody）与和弦（Chord）等，都可以被用来驱动游戏内各个方面的表现，甚至是影响玩法。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="#reference" class="hash-link" aria-label="Reference的直接链接" title="Reference的直接链接">​</a></h2>
<p><a href="https://www.audiokinetic.com/library/edge/?source=SDK&amp;id=soundengine_events.html" target="_blank" rel="noopener noreferrer">Wwise SDK - Integration Details - Events</a><br>
<a href="https://www.audiokinetic.com/library/edge/?source=SDK&amp;id=soundengine_music_callbacks.html" target="_blank" rel="noopener noreferrer">Wwise SDK - Integration Details - Music Callbacks</a><br>
<a href="https://www.audiokinetic.com/library/edge/?source=SDK&amp;id=soundengine_triggers.html" target="_blank" rel="noopener noreferrer">Wwise SDK - Integration Details - Triggers</a><br>
<a href="https://www.audiokinetic.com/library/edge/?source=SDK&amp;id=soundengine_query_pos.html" target="_blank" rel="noopener noreferrer">Wwise SDK - Integration Details - GetSourcePlayPosition</a><br>
<a href="https://www.audiokinetic.com/library/edge/?source=SDK&amp;id=namespace_a_k_1_1_music_engine_ad10a9fa99ddf21c91718c52da48e460c.html" target="_blank" rel="noopener noreferrer">Wwise SDK - GetPlayingSegmentInfo</a><br>
<a href="https://www.audiokinetic.com/library/edge/?source=SDK&amp;id=struct_ak_segment_info.html" target="_blank" rel="noopener noreferrer">Wwise SDK - AkSegmentInfo Struct</a><br>
<a href="https://www.audiokinetic.com/zh/library/edge/?source=SDK&amp;id=_ak_callback_8h_a948c083ff18dc4c8dfe1d32cb0eb6732.html" target="_blank" rel="noopener noreferrer">Wwise SDK - AkCallbackType</a><br>
<a href="https://alessandrofama.com/tutorials/wwise-ue4/playback-position/" target="_blank" rel="noopener noreferrer">Alessandro Fama - Playback position of sounds with Wwise + UE4</a><br>
<a href="https://docs.unrealengine.com/en-US/BlueprintAPI/Utilities/GetDataTableRow/index.html" target="_blank" rel="noopener noreferrer">UE API - Get Data Table Row</a></p>
<p>希辰<br>
<!-- -->2021.3.20</p>
<hr></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/Game-Audio-Design/zh-Hans/Topic/A-Practice-of-Audio-Visualization-with-UE-Wwise"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">“音频可视化” UE &amp; Wwise 实践案例</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Game-Audio-Design/zh-Hans/Topic/A-Procedural-Way-of-Melee-Weapon-Whoosh-Sound-Design"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">冷兵器 Procedural Whoosh 音频设计案例</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#明确设计需求" class="table-of-contents__link toc-highlight">明确设计需求</a></li><li><a href="#尝试使用-wwise-trigger-功能" class="table-of-contents__link toc-highlight">尝试使用 Wwise Trigger 功能</a></li><li><a href="#那就自己动手写吧" class="table-of-contents__link toc-highlight">那就自己动手写吧</a><ul><li><a href="#获取当前播放位置信息" class="table-of-contents__link toc-highlight">获取当前播放位置信息</a></li><li><a href="#获取节拍点位置信息" class="table-of-contents__link toc-highlight">获取节拍点位置信息</a></li><li><a href="#计算函数调用时间点" class="table-of-contents__link toc-highlight">计算函数调用时间点</a></li></ul></li><li><a href="#最终实现" class="table-of-contents__link toc-highlight">最终实现</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>